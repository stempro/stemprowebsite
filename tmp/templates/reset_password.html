<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reset Password</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/frmstyles.css') }}">
    <style>
        /* Error Message Styling */
        #code-error, #password-error {
            color: #e84113;
            display: none;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 10px;
        }

        /* Grayed-out style for disabled reset button */
        #reset-button:disabled {
            background-color: #d3d3d3;
            color: #a1a1a1;
            cursor: not-allowed;
        }

        /* Password visibility icon */
        .toggle-password {
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        /* Distinct styling for the code input field */
        #reset-code {
            background-color: #fffbcc;
            border: 2px solid #ffd700;
            font-weight: bold;
            text-align: center;
            font-size: 1.2rem;
        }

        /* Resend code link styling */
        #reset-code-link {
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            display: none;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Center-aligning input fields */
        .form-group input {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <div class="form-header">
                <h2>Password Reset</h2>
            </div>
            <p>We have sent you a 6-digit code to your email. Please enter the code to reset your password. The code will expire in 24 hours.</p>

            <!-- Reset Password Form -->
            <form action="/reset_password" method="post" onsubmit="return validateAndSubmit();" autocomplete="off">
                <div class="form-group">
                    <label for="email" class="sr-only">Email Address</label>
                    <input type="email" class="form-control" id="email" name="email" value="{{ email }}" readonly>
                </div>
                <div class="form-group">
                    <label for="reset-code" class="sr-only">Reset Code</label>
                    <input type="text" class="form-control" id="reset-code" name="reset_code" placeholder="Enter 6-digit code" required>
                    <div id="code-error"></div>
                </div>
                <div class="form-group" style="position: relative;">
                    <label for="new-password" class="sr-only">New Password</label>
                    <input type="password" class="form-control" id="new-password" name="new_password" placeholder="New Password" required>
                    <span class="toggle-password" onclick="togglePasswordVisibility('new-password')">üëÅÔ∏è</span>
                </div>
                <div class="form-group" style="position: relative;">
                    <label for="repeat-password" class="sr-only">Repeat New Password</label>
                    <input type="password" class="form-control" id="repeat-password" name="repeat_password" placeholder="Repeat New Password" required>
                    <span class="toggle-password" onclick="togglePasswordVisibility('repeat-password')">üëÅÔ∏è</span>
                </div>
                <div id="password-error"></div>
                <button type="submit" class="btn btn-primary" id="reset-button">Reset Password</button>
            </form>
            <div class="text-center" style="margin-top: 20px;">
                <p><a href="https://www.stempro.org" target="_blank">Go Back to StemPro Academy</a></p>
            </div>
        </div>
    </div>

    <!-- Password validation and code verification scripts -->
    <script>
        function validateAndSubmit() {
            const code = document.getElementById('reset-code').value.trim();
            const newPassword = document.getElementById('new-password').value;
            const repeatPassword = document.getElementById('repeat-password').value;
            const codeError = document.getElementById('code-error');
            const passwordError = document.getElementById('password-error');

            // Clear error messages
            codeError.style.display = "none";
            passwordError.style.display = "none";

            // Validate reset code
            if (!/^\d{6}$/.test(code)) {
                codeError.textContent = "Invalid code. Please enter a 6-digit code.";
                codeError.style.display = "block";
                return false;
            }

            // Validate password strength
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&\W]{8,}$/;
            if (!passwordRegex.test(newPassword)) {
                passwordError.textContent = "Password must be at least 8 characters long, include an uppercase letter, a lowercase letter, a number, and a special character.";
                passwordError.style.display = "block";
                return false;
            }

            // Validate password match
            if (newPassword !== repeatPassword) {
                passwordError.textContent = "Passwords do not match.";
                passwordError.style.display = "block";
                return false;
            }

            // Verify code asynchronously before submitting
            return fetch('/verify_code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.match) {
                    return true; // Allow form submission
                } else {
                    codeError.textContent = "Invalid code. Please try again.";
                    codeError.style.display = "block";
                    return false;
                }
            })
            .catch(error => {
                console.error("Error verifying code:", error);
                codeError.textContent = "An unexpected error occurred. Please try again later.";
                codeError.style.display = "block";
                return false;
            });
        }

        function togglePasswordVisibility(fieldId) {
            const passwordField = document.getElementById(fieldId);
            passwordField.type = passwordField.type === "password" ? "text" : "password";
        }
    </script>
</body>
</html>
